name: Build-container-image
description: Build container image
inputs:
  cache-build:
    description: Cache build
    default: "false"
  container-repository:
    description: Container repository
    required: true
    default: "ghcr.io/${{ github.repository_owner }}"
  image-name:
    description: Image name
    required: true
  containerfile:
    description: Containerfile name
    required: true
runs:
  using: composite
  steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install cosign
      uses: sigstore/cosign-installer@v3

    - name: Set current date as variable
      id: date
      shell: bash
      run: echo "date=$(date +%Y%m%d%H%M)" >> $GITHUB_OUTPUT

    - name: Log in to ghcr.io
      uses: redhat-actions/podman-login@v1.7
      with:
        registry: ${{ inputs.container-repository }}
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Create dnf5 cache directory
      if: ${{ inputs.cache-build == 'true' }}
      shell: bash
      run: mkdir -p /tmp/libdnf5/

    - name: Cache RPM packages
      if: ${{ inputs.cache-build == 'true' }}
      uses: actions/cache@v4
      with:
        path: /tmp/libdnf5/
        key: rpm-cache-${{ inputs.image-name }}-${{ hashFiles(format('**/{0}', inputs.containerfile)) }}
        restore-keys: |
          rpm-cache-${{ inputs.image-name }}-

    - name: Build extra arguments for buildah
      if: ${{ inputs.cache-build == 'true' }}
      id: cache-build
      shell: bash
      env:
        USE_CACHE: "${{ github.event_name != 'schedule' }}"
        CACHE_IMAGE: "${{ inputs.container-repository }}/${{ inputs.image-name }}-cache"
      run: |
        EXTRA_ARGS="--volume /tmp/libdnf5:/var/cache/libdnf5:z"
        if [[ "${{ env.USE_CACHE }}" == "true" ]]; then
          EXTRA_ARGS+=" --cache-from $CACHE_IMAGE --cache-to $CACHE_IMAGE"
        else
          EXTRA_ARGS+=" --cache-to $CACHE_IMAGE --no-cache"
        fi
        echo "extra-args=$EXTRA_ARGS" >> $GITHUB_OUTPUT

    - name: Build container image
      id: build-image
      uses: redhat-actions/buildah-build@v2.13
      with:
        context: "./bootc/${{ inputs.image-name }}/"
        containerfiles: "./bootc/${{ inputs.image-name }}/${{ inputs.containerfile-name }}"
        image: ${{ inputs.image-name }}
        tags: latest ${{ steps.date.outputs.date }}
        layers: true
        oci: true
        extra-args: ${{ steps.cache-build.outputs.extra-args }}

    - name: Push to ghcr.io
      uses: redhat-actions/push-to-registry@v2.6
      with:
        image: ${{ steps.build-image.outputs.image }}
        tags: ${{ steps.build-image.outputs.tags }}
        registry: ${{ inputs.container-repository }}

    - name: Sign image
      shell: bash
      run: |
        DIGEST=$(skopeo inspect docker://${IMAGE_REGISTRY}/${IMAGE_NAME }:latest | jq -r '.Digest')
        cosign sign --yes --key env://COSIGN_PRIVATE_KEY ${IMAGE_REGISTRY}/${IMAGE_NAME }@${DIGEST}
      env:
        IMAGE_REGISTRY: ${{ inputs.container-repository }}
        IMAGE_NAME: ${{ inputs.image-name }}
        COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY  }}
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}

    - name: cleanup untagged images
      uses: actions/delete-package-versions@v5
      with:
        package-name: ${{ inputs.image-name }}
        package-type: container
        min-versions-to-keep: 0
        delete-only-untagged-versions: true
        token: ${{ github.token }}

    - name: cleanup old images
      uses: actions/delete-package-versions@v5
      with:
        package-name: ${{ inputs.image-name }}
        package-type: container
        min-versions-to-keep: ${{ inputs.num-packages-to-keep }}
        token: ${{ github.token }}

    - name: cleanup old cache images
      uses: actions/delete-package-versions@v5
      if: ${{ inputs.cache-build == 'true' }}
      with:
        package-name: ${{ inputs.image-name }}-cache
        package-type: container
        min-versions-to-keep: 1
        delete-only-untagged-versions: true
        token: ${{ github.token }}
